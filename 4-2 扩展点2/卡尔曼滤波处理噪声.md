# 扩展点2――使用卡尔曼滤波处理噪声    

## 知识笔记         
平滑:根据过去和现在的量测修正过去的估计      
滤波:根据过去和现在的量测优化现在的估计      
预测:根据过去和现在的量测预测未来的估计        

**1.卡尔曼滤波的专业解释**     
卡尔曼滤波基于线性动态系统的状态方程和观测方程，通过预测和更新两个主要步骤，不断逼近系统的真实状态。       
> 三小句分别表明了使用条件，工作流程，最终功能。     

**2.卡尔曼滤波的通俗解释**
现有不准的估计值，不准的测量值，卡尔曼滤波能利用这俩算出一个最接近真实值的数据。     

**3.卡尔曼滤波的特点**
- 卡尔曼滤波本质是一个递归算法，只需要前一时刻的状态估计和协方差矩阵，不需要存储所有历史数据。    
- 卡尔曼滤波用到了数据融合的思想，估计值和测量值之间生成最优，哪个误差大，就不信任哪个。    
- 卡尔曼滤波中的噪声都是高斯噪声（正态分布）。  

**4.直观图像初识卡尔曼滤波**  
这是用Excel呈现出来的卡尔曼滤波效果：尽管初始估计值很小，波形从第六个点开始就平稳逼近真实值100了。
由这个例子我们可以看到几个重要的量：    
测量值，测量误差，估计值，估计误差，卡尔曼增益
<img src="kalman_Excel.png" style="width:100%; padding-left: 0%;"/>      

**5.理论基础**     

数学篇：    
- **数据融合**      
现测量一个物体得到两个数据$z_1$，$z_2$，两者的标准差（误差）分别为$σ_1$,$σ_2$。利用以上数据估计真实值z的过程就叫数据融合。      
下面为求最优估计值的过程（使估计值的方差最小）：      
<img src="卡尔曼1.jpg" style="width:100%; padding-left: 0%;"/>       

- **协方差矩阵**  
协方差矩阵中的第i行第j列元素表示第i个和第j个随机变量之间的协方差。如果i等于j，则该元素表示第i个随机变量的方差。
    - 协方差矩阵是对称的，即Cov(X,Y) = Cov(Y,X)。
    - 如果两个随机变量是独立的，那么它们的协方差为0。
    - 计算公式：
<img src="协方差矩阵.png" style="width:100%; padding-left: 0%;"/>       
其中，$x_i$ 和 $y_i$ 是X和Y的第i个观测值，$μ_x$  和 $μ_y$ 是X和Y的平均值，n是观测值的数量。
    - 协方差如果是一个大的正值，说明两个变量的变化方向一致，即正相关。
    协方差如果是一个负值，说明两个变量的变化方向相反，即负相关。
    - 用过渡矩阵（测量的n组数据构成）表示协方差矩阵：例如过渡矩阵
<img src="协方差矩阵2.png" style="width:100%; padding-left: 0%;"/>       
    则协方差矩阵P=$\frac{1}{3}$$a^T$$a$（展开后就是协方差的计算公式）    
  
- **状态空间方程**     
状态空间方程用于描述动态系统。一个动态系统可以通过一组*一阶微分方程*（对于连续时间系统）或*差分方程*（对于离散时间系统）来描述。这些方程定义了系统状态变量随时间的变化规律，以及这些状态变量如何受到*输入*(控制信号)和*内部参数*的影响。
    > 听着很抽象，其实这个状态空间方程在我们解算姿态角时更新四元数部分碰到过，当时还把连续时间系统直接转化为了离散时间系统（不过这样直接转化不一定对）
<img src="卡尔曼2.png" style="width:80%; padding-left: 10%;"/>       
这就是一个一阶微分方程，展开就是更新四元数的公式。    
    
    用一个弹簧阻尼系统（一种利用弹簧和阻尼元件相互作用的系统）来理解状态转移方程：
    <img src="卡尔曼3.jpg" style="width:100%; padding-left: 0%;"/>  
    得出状态空间方程（连续时间系统）：
    $$
    \dot{x}(t) = A {x}(t) + B {u}(t) ，\\        
    \ {z}(t) = H {x}(t) \\
    $$
    - $ \dot{\mathbf{x}}(t) $ 表示状态变量 $ \mathbf{x}(t) $ 对时间 $ t $ 的导数（或差分，  对于离散时间系统）。
    - **$ A $ 是系统矩阵**，描述了内部状态变量之间的相互作用，就是上一次和下一次的联系。
    - **$ B $ 是输入矩阵**，描述了输入变量如何影响系统状态。
    - $ u $ 是控制或系统输入，比如弹簧阻尼系统中的那个力F。
    - $ \mathbf{z}(t) $ 是系统的输出变量或测量值（可能是一个或多个，上面的例子就是两个）。
    - **$ H $ 是输出矩阵或观测矩阵**，可理解为描述测量值与测量估计值之间关系的一个关键组成部分。    
    
    状态空间方程（本节卡尔曼滤波用的离散时间系统） 
    $$
    \ {x_k} = A {x_{k-1}} + B {u_{k-1}} + {w_{k-1}} ，\\        
    \ {z_k} = H {x_{k}} + {v_{k}} \\
    $$

    可以看出两组状态空间方程都是反应了一种变化。由于估计和测量都是有误差的（过程噪声w，测量噪声v，**过程噪声协方差矩阵Q**，**测量噪声协方差矩阵R**），所以如何估计精确估计$x_k$就成了需要解决的问题。而这就是卡尔曼滤波能做的。  

名词解释篇：    

- **先验估计和后验估计**
    - 先验估计是依据之前的后验估计所得的出来的当前估计值，对应公式为：
    <img src="先验估计.png" style="width:80%; padding-left:10%;"/>   
    就是暂不考虑过程噪声的状态空间方程。     
    - 后验估计是利用本次测量估计值，对先验估计进行修正后的估计值，对应公式为：
    $$\ {x_k} = \ {x^-_k} + {G} ( {H^-{z_k}}-\ {x^-_k})$$这也体现了数据融合的思想。令$G$=$K_k$$H$得到：     
    $$\ {x_k} = \ {x^-_k} + {K_k} ( {z_k}-H\ {x^-_k})$$$K_k$为卡尔曼增益。

- **卡尔曼增益**      
在“数据融合”部分已经提到过，其中算出来的影响系数K其实就是卡尔曼增益。    
在卡尔曼滤波的情景下，$z_1$，$z_2$变成了先验估计$X^-_k$和测量估计$X_k(mea)$(状态空间方程的第二个式子中的$X_k$)，同样也都不准，受过程，测量噪声影响，最优估计值$z$则变成了后验估计。    
$K_k$的取值与两种噪声息息相关，$K_k$更愿意信任误差小的一方。   
同样要找$K_k$，就要让后验估计与真实值的误差e的方差最小（因为e的期望为0，方差越小越接近期望值，也就是0），等价于使**误差e的协方差矩阵P**的迹（对角线相加，对角线都是方差）tr(P)最小。$K_k$的极简推导如下：
    <img src="卡尔曼增益.png" style="width:100%; padding-left:0%;"/>   
由于是一般情况，所以计算很复杂，但是1.表示方差2.对K求导.的思路仍然和数据融合一样,且最后答案的表达形式也如出一辙。   

- **先验误差协方差**
由先验估计，后验估计，卡尔曼增益的三个公式可以分析出：要想求出后验估计，就只有$P^-_k$是未知量了，**而$P^-_k$就是先验误差协方差**，其含义已在上图中标明。
求先验误差协方差要将完整的一组状态转移方程代入，化简：
    <img src="先验误差协方差.jpg" style="width:100%; padding-left:0%;"/> 

- **更新误差协方差**
由先验误差协方差公式可以看出，要求先验误差协方差$P^-_k$，每次都需要上一次的误差协方差$P_k$,所以更新步骤不可或缺。
更新方法是：在卡尔曼增益部分，直接将算得的卡尔曼增益代回$P_k$表达式，化简便可得到更新方程。

**6.卡尔曼滤波五大公式**     
至此，有了理论基础的阐述，卡尔曼滤波五大公式终于集齐。
<img src="五大公式.jpg" style="width:100%; padding-left:0%;"/>   
那么，只需要给定初始估计值$x_0$,初始误差协方差$P_0$，整个系统便可以自回归运作起来。    
先验估计-->先验误差协方差-->卡尔曼增益-->后验估计-->更新误差协方差      

## 实现步骤        
对pitch，roll角进行卡尔曼滤波的实现思路：    
因为MPU6050没有包含磁力计，故无法对yaw轴运用卡尔曼滤波算法。利用MPU6050中加速度传感器采集到的xyz轴的加速度，得到pitch轴和roll轴的原始角度，再利用角速度进行卡尔曼滤波处理，最终得到滤波后的角度数据。
- 两个处理对象：对角度angle，陀螺仪偏移量w_bias进行二维卡尔曼滤波
- 将对应的矩阵代入推导出的五大公式：    
    <img src="五大公式2.jpg" style="width:100%; padding-left:0%;"/>   
然后将式子化简并转化成程序语言即可。   

以roll角的卡尔曼滤波为例：      

**1. 定义常值参数**    
过程噪声Q表示对系统模型中噪声的估计。Q设置得较小，表明对系统模型的信任度较高，系统状态的预测与实际值差异不大。          
测量噪声R表示对测量过程中噪声的估计。R设置得较小，表示对测量数据的信任度较高，测量数据与实际值差异不大。
~~~
static float Q_angle = 0.001f;		//角度的过程误差协方差
static float Q_gyro  = 0.003f;		//漂移角速度的过程误差协方差  
static float R_angle = 0.5f;		//角度的测量误差协方差
static float dt      = 0.01f;		//采样周期即计算任务周期10ms
~~~
**2. 第一式――先验估计**
~~~
static float w_bias_x = 0.0f;	//陀螺仪角速度的偏差
static float K_Roll_0, K_Roll_1;	//卡尔曼增益
static float P_R[2][2] = { { 1, 0 },{ 0, 1 } };//过程协方差矩阵P，初始值为单位阵

float roll_est = *roll_kf + (GX_kf - w_bias_x) * dt; //状态方程,角度值等于上次最优角度加角速度减零漂后积分
w_bias_x = w_bias_x;
~~~
**3. 第二式――先验误差协方差**
~~~
//写P_Roll先验误差协方差矩阵，省去化简后的dt平方项
P_R[0][0] = P_R[0][0] + Q_angle - (P_R[0][1] + P_R[1][0])*dt;
P_R[0][1] = P_R[0][1] - P_R[1][1]*dt;
P_R[1][0] = P_R[1][0] - P_R[1][1]*dt;
P_R[1][1] = P_R[1][1] + Q_gyro; 
~~~
**4. 第三式――卡尔曼增益**
~~~
//有先验误差就可以求
K_Roll_0 = P_R[0][0] / (P_R[0][0] + R_angle);
K_Roll_1 = P_R[1][0] / (P_R[0][0] + R_angle);
~~~
**5. 第四式――后验估计**
~~~
//数据融合思想
*roll_kf = roll_est + K_Roll_0 * (roll_acc - roll_est);
w_bias_x = w_bias_x + K_Roll_1 * (roll_acc - roll_est);
~~~
**6. 第五式――更新误差协方差**
~~~
//一定要注意顺序，避免元素被覆盖，更新一定是在旧值的基础上算
P_R[1][0] = P_R[1][0] - K_Roll_1 * P_R[0][0];
P_R[0][0] = P_R[0][0] - K_Roll_0 * P_R[0][0];
P_R[1][1] = P_R[1][1] - K_Roll_1 * P_R[0][1];
P_R[0][1] = P_R[0][1] - K_Roll_0 * P_R[0][1];
~~~    
**7. 在中断函数中调用滤波函数，主函数输出滤波结果**
~~~
//接受角度，角速度，输出最优值
Kalman_Filter_Pitch(pitch_acc,&pitch_kf,GY_Convert);
Kalman_Filter_Roll(roll_acc,&roll_kf,GX_Convert);
~~~

## 框图     
       
<img src="扩展2框图.png" style="width:80%; padding-left: 10%;"/>      
      
## 照片    
    
<img src="扩展2照片.jpg" style="width:80%; padding-left: 10%;"/>      

